<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Linked List Visualizer</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" />

    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #editor {
            width: 600px;
            height: 300px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        #output,
        #steps {
            width: 600px;
            min-height: 80px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #fefefe;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        #visualization {
            margin-top: 20px;
            width: 600px;
            min-height: 120px;
            border: 1px solid #ccc;
            background-color: #fff;
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 10px;
            position: relative;
        }

        .node {
            padding: 12px 20px;
            background-color: #2196F3;
            color: white;
            border-radius: 8px;
            margin-right: 15px;
            font-weight: bold;
            white-space: nowrap;
        }

        .arrow {
            font-size: 24px;
            user-select: none;
            margin-right: 15px;
        }

        #stepControls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        a#backBtn {
            margin-top: 20px;
            display: inline-block;
            text-decoration: none;
            color: #333;
            font-weight: bold;
        }

        footer {
            display: flex;
            justify-content: end;
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: orange;
            padding: 10px;
            color: white;
        }
    </style>
</head>

<body>

    <h1>Linked List Visualizer</h1>

    <div id="editor"></div>
    <div style="display: flex; margin: 5px;">
        <button id="runBtn">Run</button>
        <button id="downloadBtn" style="margin-left: 5px;">Download Visualization as Image</button>
    </div>

    <div id="output">Output will appear here</div>
    <div id="visualization">Visualization will appear here</div>

    <div id="stepControls">
        <button id="prevStep">Previous Step</button>
        <button id="nextStep">Next Step</button>
    </div>

    <div id="steps">Steps will appear here</div>

    <a href="index.html" id="backBtn">&larr; Back to Index</a>
    <footer>
        <span style="margin-right: 30px;">Prototype Made by <a href="https://github.com/Earth123456789"
                style="color: white;">Earth123456789</a></span>
    </footer>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        const editor = CodeMirror(document.getElementById("editor"), {
            mode: "python",
            lineNumbers: true,
            value: `log = []

class Node:
    def __init__(self, val):
        self.val = val
        self.next = None

class LinkedList:
    def __init__(self):
        self.head = None

    def append(self, val):
        if not self.head:
            self.head = Node(val)
            log.append((self.to_list(), f"Append {val} (head)"))
            return
        curr = self.head
        while curr.next:
            curr = curr.next
        curr.next = Node(val)
        log.append((self.to_list(), f"Append {val}"))

    def remove(self, val):
        prev = None
        curr = self.head
        while curr:
            if curr.val == val:
                if prev:
                    prev.next = curr.next
                else:
                    self.head = curr.next
                log.append((self.to_list(), f"Remove {val}"))
                return
            prev = curr
            curr = curr.next
        log.append((self.to_list(), f"Value {val} not found"))

    def to_list(self):
        res = []
        curr = self.head
        while curr:
            res.append(curr.val)
            curr = curr.next
        return res

ll = LinkedList()
ll.append(10)
ll.append(20)
ll.append(30)
ll.remove(20)
ll.append(40)

data_type = "linkedlist"
data = ll.to_list()
`
        });

        let pyodideReadyPromise = loadPyodide();

        let currentStep = 0;
        let stepsData = [];

        function updateVisualizationStep(step) {
            const container = document.getElementById("visualization");
            container.innerHTML = "";
            container.classList.remove("stack"); // Ensure stack style off
            container.classList.add("linkedlist");

            if (!stepsData.length) {
                container.textContent = "No data to visualize.";
                return;
            }

            const { data, logMsg } = stepsData[step];

            for (let i = 0; i < data.length; i++) {
                const node = document.createElement("div");
                node.className = "node";
                node.textContent = data[i];
                container.appendChild(node);

                if (i !== data.length - 1) {
                    const arrow = document.createElement("div");
                    arrow.className = "arrow";
                    arrow.textContent = "â†’";
                    container.appendChild(arrow);
                }
            }

            document.getElementById("steps").textContent = `${step + 1}. ${logMsg}`;
        }

        document.getElementById("runBtn").addEventListener("click", async () => {
            const pyodide = await pyodideReadyPromise;
            const code = editor.getValue();

            try {
                let output = await pyodide.runPythonAsync(`
import sys
import io
sys.stdout = io.StringIO()
` + code + `
sys.stdout.getvalue()
    `);

                document.getElementById("output").textContent = output;

                let resultJSON = await pyodide.runPythonAsync(`
import json
def convert_log():
    out = []
    for state, msg in log:
        out.append({"data": state, "msg": msg})
    return out

try:
    json.dumps(data)
except Exception:
    data = []

try:
    data_type
except NameError:
    data_type = "list"

try:
    json.dumps(log)
except Exception:
    log = []

json.dumps({"type": data_type, "steps": convert_log()})
    `);

                let result = JSON.parse(resultJSON);

                stepsData = result.steps.map(step => ({
                    data: step.data,
                    logMsg: step.msg
                }));

                currentStep = 0;
                updateVisualizationStep(currentStep);

            } catch (err) {
                document.getElementById("output").textContent = "Error: " + err;
                document.getElementById("visualization").innerHTML = "Visualization will appear here";
                document.getElementById("steps").textContent = "Steps will appear here";
            }
        });

        document.getElementById("prevStep").addEventListener("click", () => {
            if (currentStep > 0) {
                currentStep--;
                updateVisualizationStep(currentStep);
            }
        });

        document.getElementById("nextStep").addEventListener("click", () => {
            if (currentStep < stepsData.length - 1) {
                currentStep++;
                updateVisualizationStep(currentStep);
            }
        });

        document.getElementById("downloadBtn").addEventListener("click", () => {
            const visualization = document.getElementById("visualization");
            html2canvas(visualization).then(canvas => {
                const dataURL = canvas.toDataURL("image/png");
                const link = document.createElement("a");
                link.href = dataURL;
                link.download = `step_${currentStep + 1}.png`;
                link.click();
            });
        });
    </script>

</body>

</html>